{"changed":true,"filter":false,"title":"app.js","tooltip":"/node/app.js","value":"'use strict';\n\nconst\n  bodyParser = require('body-parser'),\n  config = require('config'),\n  crypto = require('crypto'),\n  express = require('express'),\n  https = require('https'),\n  mysql = require('mysql'),\n  request = require('request');\n\nvar app = express();\napp.set('port', process.env.PORT || 5000);\napp.set('view engine', 'ejs');\napp.use(bodyParser.json({ verify: verifyRequestSignature }));\napp.use(express.static('public'));\n\n\n// Credentials\nconst \n  APP_SECRET        =   config.get('appSecret'),\n  VALIDATION_TOKEN  =   config.get('validationToken'),\n  PAGE_ACCESS_TOKEN =   config.get('pageAccessToken'),\n  SERVER_URL        =   config.get('serverURL'),\n  API_URL           =   config.get('apiURL'),\n  DB_HOST           =   config.get('dbHost'),\n  DB_USER           =   config.get('dbUser'),\n  DB_PW             =   config.get('dbPassword'),\n  DB_NAME           =   config.get('dbName');\n  \nvar connection = mysql.createConnection({\n  host        :   DB_HOST,\n  user        :   DB_USER,\n  password    :   DB_PW,\n  database    :   DB_NAME\n});\n\nconst ErrorEnum = {\n  DBERROR : \"Database connection error :( Please try again later.\",\n  INTERNALERROR: \"Internal error :( Please try again later.\"\n};\n\nconnection.connect(function(err) {\n  if (err) sendTextMessage(senderID, ErrorEnum.DBERROR);\n});\n\nvar inputMode = '';\nvar className = '';\nvar assDate = '';\nvar assName = '';\n\napp.get('/webhook', function(req, res) {\n  if (req.query['hub.mode'] === 'subscribe' &&\n      req.query['hub.verify_token'] === VALIDATION_TOKEN) {\n    console.log(\"Validating webhook\");\n    res.status(200).send(req.query['hub.challenge']);\n  } else {\n    console.error(\"Failed validation. Make sure the validation tokens match.\");\n    res.sendStatus(403);\n  }\n});\n\n\n/*\n * All callbacks for Messenger are POST-ed. They will be sent to the same\n * webhook. Be sure to subscribe your app to your page to receive callbacks\n * for your page.\n * https://developers.facebook.com/docs/messenger-platform/product-overview/setup#subscribe_app\n *\n */\napp.post('/webhook', function (req, res) {\n  var data = req.body;\n\n  // Make sure this is a page subscription\n  if (data.object == 'page') {\n    // Iterate over each entry\n    // There may be multiple if batched\n    data.entry.forEach(function(pageEntry) {\n      var pageID = pageEntry.id;\n      var timeOfEvent = pageEntry.time;\n\n      // Iterate over each messaging event\n      pageEntry.messaging.forEach(function(messagingEvent) {\n        if (messagingEvent.optin) {\n          receivedAuthentication(messagingEvent);\n        } else if (messagingEvent.message) {\n          receivedMessage(messagingEvent);\n        } else if (messagingEvent.delivery) {\n          receivedDeliveryConfirmation(messagingEvent);\n        } else if (messagingEvent.postback) {\n          receivedPostback(messagingEvent);\n        } else if (messagingEvent.read) {\n          receivedMessageRead(messagingEvent);\n        } else if (messagingEvent.account_linking) {\n          receivedAccountLink(messagingEvent);\n        } else {\n          console.log(\"Webhook received unknown messagingEvent: \", messagingEvent);\n        }\n      });\n    });\n\n    // Assume all went well.\n    //\n    // You must send back a 200, within 20 seconds, to let us know you've\n    // successfully received the callback. Otherwise, the request will time out.\n    res.sendStatus(200);\n  }\n});\n\n/*\n * This path is used for account linking. The account linking call-to-action\n * (sendAccountLinking) is pointed to this URL.\n *\n */\napp.get('/authorize', function(req, res) {\n  var accountLinkingToken = req.query.account_linking_token;\n  var redirectURI = req.query.redirect_uri;\n\n  // Authorization Code should be generated per user by the developer. This will\n  // be passed to the Account Linking callback.\n  var authCode = \"1234567890\";\n\n  // Redirect users to this URI on successful login\n  var redirectURISuccess = redirectURI + \"&authorization_code=\" + authCode;\n\n  res.render('authorize', {\n    accountLinkingToken: accountLinkingToken,\n    redirectURI: redirectURI,\n    redirectURISuccess: redirectURISuccess\n  });\n});\n\n/*\n * Verify that the callback came from Facebook. Using the App Secret from\n * the App Dashboard, we can verify the signature that is sent with each\n * callback in the x-hub-signature field, located in the header.\n *\n * https://developers.facebook.com/docs/graph-api/webhooks#setup\n *\n */\nfunction verifyRequestSignature(req, res, buf) {\n  var signature = req.headers[\"x-hub-signature\"];\n\n  if (!signature) {\n    // For testing, let's log an error. In production, you should throw an\n    // error.\n    console.error(\"Couldn't validate the signature.\");\n  } else {\n    var elements = signature.split('=');\n    var method = elements[0];\n    var signatureHash = elements[1];\n\n    var expectedHash = crypto.createHmac('sha1', APP_SECRET)\n                        .update(buf)\n                        .digest('hex');\n\n    if (signatureHash != expectedHash) {\n      throw new Error(\"Couldn't validate the request signature.\");\n    }\n  }\n}\n\n/*\n * Authorization Event\n *\n * The value for 'optin.ref' is defined in the entry point. For the \"Send to\n * Messenger\" plugin, it is the 'data-ref' field. Read more at\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/authentication\n *\n */\nfunction receivedAuthentication(event) {\n  var senderID = event.sender.id;\n  var recipientID = event.recipient.id;\n  var timeOfAuth = event.timestamp;\n\n  // The 'ref' field is set in the 'Send to Messenger' plugin, in the 'data-ref'\n  // The developer can set this to an arbitrary value to associate the\n  // authentication callback with the 'Send to Messenger' click event. This is\n  // a way to do account linking when the user clicks the 'Send to Messenger'\n  // plugin.\n  var passThroughParam = event.optin.ref;\n\n  console.log(\"Received authentication for user %d and page %d with pass \" +\n    \"through param '%s' at %d\", senderID, recipientID, passThroughParam,\n    timeOfAuth);\n\n  // When an authentication is received, we'll send a message back to the sender\n  // to let them know it was successful.\n  sendTextMessage(senderID, \"Authentication successful\");\n}\n\n/*\n * Message Event\n *\n * This event is called when a message is sent to your page. The 'message'\n * object format can vary depending on the kind of message that was received.\n * Read more at https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-received\n *\n * For this example, we're going to echo any text that we get. If we get some\n * special keywords ('button', 'generic', 'receipt'), then we'll send back\n * examples of those bubbles to illustrate the special message bubbles we've\n * created. If we receive a message with an attachment (image, video, audio),\n * then we'll simply confirm that we've received the attachment.\n *\n */\nfunction receivedMessage(event) {\n  var senderID = event.sender.id;\n  console.log(senderID);\n  var recipientID = event.recipient.id;\n  var timeOfMessage = event.timestamp;\n  var message = event.message;\n\n  console.log(\"Received message for user %d and page %d at %d with message:\",\n    senderID, recipientID, timeOfMessage);\n  console.log(JSON.stringify(message));\n\n  var isEcho = message.is_echo;\n  var messageId = message.mid;\n  var appId = message.app_id;\n  var metadata = message.metadata;\n\n  // You may get a text or attachment but not both\n  var messageText = message.text;\n  var messageAttachments = message.attachments;\n  var quickReply = message.quick_reply;\n\n  if (isEcho) {\n    // Just logging message echoes to console\n    console.log(\"Received echo for message %s and app %d with metadata %s\",\n      messageId, appId, metadata);\n    return;\n  } else if (quickReply) {\n    var quickReplyPayload = quickReply.payload;\n    console.log(\"Quick reply for message %s with payload %s\",\n      messageId, quickReplyPayload);\n\n    sendTextMessage(senderID, \"Quick reply tapped\");\n    return;\n  }\n\n  if (messageText) {\n    // If we receive a text message, check to see if it matches any special\n    // keywords and send back the corresponding example. Otherwise, just echo\n    // the text we received.\n    if (inputMode.localeCompare(\"\") != 0) {\n    switch (inputMode) {\n      case 'ADD_CLASS_GET_CLASS_NAME':\n        className = messageText;\n        inputMode = '';\n        break;\n      case 'ENROLL_CLASS_GET_CLASS_NAME':\n        className = messageText;\n        inputMode = '';\n        connection.query('SELECT * FROM classes WHERE ?', {name: messageText},\n        function(err, rows, fields) {\n          if (err) console.log(err.code);\n          if (rows.length != 0) {\n            connection.query('INSERT INTO user_class SET ?', {uid: senderID, cid: rows[0].id})\n          } else {\n            sendTextMessage(senderID, 'Class not found. Adding into database..');\n            connection.query('INSERT INTO classes SET ?', {name: messageText},\n              function(err, result) {\n                if (err) console.log(err.code);\n                console.log(result.insertCode);\n            });\n            sendTextMessage(senderID, 'class = ' + messageText);\n          }\n        })\n        break;\n      case 'DROP_CLASS_GET_CLASS_NAME':\n        className = messageText;\n        inputMode = '';\n        sendTextMessage(senderID, 'dropped class ' + messageText);\n        break;\n      case 'ADD_ASS_GET_CLASS':\n        className = messageText;\n        inputMode = 'ADD_ASS_GET_ASS_NAME';\n        sendTextMessage(senderID, 'class = ' + messageText);\n        break;\n      case 'ADD_ASS_GET_ASS_NAME':\n        assName = messageText;\n        inputMode = 'ADD_ASS_GET_ASS_DATE';\n        sendTextMessage(senderID, 'name = ' + messageText);\n        break;\n      case 'ADD_ASS_GET_ASS_DATE':\n        assDate = messageText;\n        sendTextMessage(senderID, 'date = ' + messageText);\n        //FIXME\n        // Add assignment to database\n        inputMode = '';\n        break;\n        default:\n    }\n    } else {\n    switch (messageText) {\n      case 'Menu FH':\n      case 'Menu C3':\n      case 'Menu CKC':\n      // case \n      //   sendGenericMessage(senderID);\n      //   br\n      case 'quick reply':\n        sendQuickReply(senderID);\n        break;\n      case 'read receipt':\n        sendReadReceipt(senderID);\n        break;\n      case 'typing on':\n         sendTypingOn(senderID);\n         break;\n      case 'typing off':\n        sendTypingOff(senderID);\n        break;\n      case 'account linking':\n        sendAccountLinking(senderID);\n        break;\n      case 'Physics':\n        queryDB('SELECT * FROM users');\n      default:\n        sendTextMessage(senderID, messageText);\n    }\n    }\n  } else if (messageAttachments) {\n    sendTextMessage(senderID, \"Message with attachment received\");\n  }\n}\n\n\n/*\n * Delivery Confirmation Event\n *\n * This event is sent to confirm the delivery of a message. Read more about\n * these fields at https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-delivered\n *\n */\nfunction receivedDeliveryConfirmation(event) {\n  var senderID = event.sender.id;\n  var recipientID = event.recipient.id;\n  var delivery = event.delivery;\n  var messageIDs = delivery.mids;\n  var watermark = delivery.watermark;\n  var sequenceNumber = delivery.seq;\n\n  if (messageIDs) {\n    messageIDs.forEach(function(messageID) {\n      console.log(\"Received delivery confirmation for message ID: %s\",\n        messageID);\n    });\n  }\n\n  console.log(\"All message before %d were delivered.\", watermark);\n}\n\n\n/*\n * Postback Event\n *\n * This event is called when a postback is tapped on a Structured Message.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/postback-received\n *\n */\nfunction receivedPostback(event) {\n  var senderID = event.sender.id;\n  var recipientID = event.recipient.id;\n  var timeOfPostback = event.timestamp;\n\n  // The 'payload' param is a developer-defined field which is set in a postback\n  // button for Structured Messages.\n  var payload = event.postback.payload;\n  \n  console.log(\"Received postback for user %d and page %d with payload '%s' \" +\n    \"at %d\", senderID, recipientID, payload, timeOfPostback);\n\n  // Parse payload corespondingly\n  switch (payload) {\n    case 'DUES':\n      sendDuesList(senderID);\n      break;\n    case 'ADD_CLASS':\n      inputMode = 'ADD_CLASS_GET_CLASS_NAME';\n      sendTextMessage(senderID, 'class name?');\n      break;\n    case 'DROP_CLASS':\n      inputMode = 'DROP_CLASS_GET_CLASS_NAME';\n      sendTextMessage(senderID, 'class name?');\n      break;\n    case 'ADD_ASS':\n      inputMode = 'ADD_ASS_GET_CLASS';\n      sendTextMessage(senderID, 'class name?');\n      break;\n    case 'MANAGE':\n      sendManageMenu(senderID);\n      break;\n    case 'ENROLL_CLASS':\n      inputMode = 'ENROLL_CLASS_GET_CLASS_NAME';\n      sendTextMessage(senderID, 'class name?');\n      break;\n    case 'INFO':\n      sendInfoMenu(senderID);\n      break;\n    case 'CLASS_INFO':\n      sendClassInfoMenu(senderID);\n      break;\n    case 'MY_PERSONAL_INFO':\n      sendMyPersonalInfoMenu(senderID);\n      break;\n    case 'GET_STARTED':\n      console.log('=========');\n      console.log(senderID);\n      console.log('=========');\n      connection.query('INSERT INTO users SET ?', {id: senderID},\n        function(err, result) {\n          if (err) console.log(err.code);\n      });\n      request({\n          uri: API_URL + senderID,\n          method: 'GET',\n          qs: {\n              access_token: PAGE_ACCESS_TOKEN\n          }\n      }, function(error, response, body){\n          if(error) {\n              console.log(error);\n          } else {\n            var firstName = JSON.parse(body).first_name;\n            sendTextMessage(senderID, 'Hi ' + firstName + ', how can I help you today?');\n          }\n      });\n      break;\n    default:\n      // code\n  }\n\n}\n\n\n/*\n * Message Read Event\n *\n * This event is called when a previously-sent message has been read.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-read\n *\n */\nfunction receivedMessageRead(event) {\n  var senderID = event.sender.id;\n  var recipientID = event.recipient.id;\n\n  // All messages before watermark (a timestamp) or sequence have been seen.\n  var watermark = event.read.watermark;\n  var sequenceNumber = event.read.seq;\n\n  console.log(\"Received message read event for watermark %d and sequence \" +\n    \"number %d\", watermark, sequenceNumber);\n}\n\n/*\n * Account Link Event\n *\n * This event is called when the Link Account or UnLink Account action has been\n * tapped.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/account-linking\n *\n */\nfunction receivedAccountLink(event) {\n  var senderID = event.sender.id;\n  var recipientID = event.recipient.id;\n\n  var status = event.account_linking.status;\n  var authCode = event.account_linking.authorization_code;\n\n  console.log(\"Received account link event with for user %d with status %s \" +\n    \"and auth code %s \", senderID, status, authCode);\n}\n\n/*\n * Send an image using the Send API.\n *\n */\nfunction sendImageMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"image\",\n        payload: {\n          url: SERVER_URL + \"/assets/rift.png\"\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a Gif using the Send API.\n *\n */\nfunction sendGifMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"image\",\n        payload: {\n          url: SERVER_URL + \"/assets/instagram_logo.gif\"\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send audio using the Send API.\n *\n */\nfunction sendAudioMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"audio\",\n        payload: {\n          url: SERVER_URL + \"/assets/sample.mp3\"\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a video using the Send API.\n *\n */\nfunction sendVideoMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"video\",\n        payload: {\n          url: SERVER_URL + \"/assets/allofus480.mov\"\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a file using the Send API.\n *\n */\nfunction sendFileMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"file\",\n        payload: {\n          url: SERVER_URL + \"/assets/test.txt\"\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a text message using the Send API.\n *\n */\nfunction sendTextMessage(recipientId, messageText) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      text: messageText,\n      metadata: \"DEVELOPER_DEFINED_METADATA\"\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a button message using the Send API.\n *\n */\nfunction sendButtonMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"template\",\n        payload: {\n          template_type: \"button\",\n          text: \"This is test text\",\n          buttons:[{\n            type: \"web_url\",\n            url: \"https://www.oculus.com/en-us/rift/\",\n            title: \"Open Web URL\"\n          }, {\n            type: \"postback\",\n            title: \"Trigger Postback\",\n            payload: \"DEVELOPED_DEFINED_PAYLOAD\"\n          }, {\n            type: \"phone_number\",\n            title: \"Call Phone Number\",\n            payload: \"+16505551234\"\n          }]\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a Structured Message (Generic Message type) using the Send API.\n *\n */\nfunction sendGenericMessage(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"template\",\n        payload: {\n          template_type: \"generic\",\n          elements: [{\n            title: \"Cal Dining\",\n            subtitle: \"I love Crossroads\",\n            item_url: \"http://caldining.berkeley.edu/menus/all-locations-d1\",\n            image_url: SERVER_URL + \"/assets/junk-food.jpg\",\n            buttons: [{\n              type: \"web_url\",\n              url: \"https://www.oculus.com/en-us/rift/\",\n              title: \"Cal Dining\"\n            }, {\n              type: \"postback\",\n              title: \"Follow on Facebook\",\n              payload: \"Payload for first bubble\",\n            }],\n          }, {\n            title: \"touch\",\n            subtitle: \"Your Hands, Now in VR\",\n            item_url: \"https://www.oculus.com/en-us/touch/\",\n            image_url: SERVER_URL + \"/assets/touch.png\",\n            buttons: [{\n              type: \"web_url\",\n              url: \"https://www.oculus.com/en-us/touch/\",\n              title: \"Open Web URL\"\n            }, {\n              type: \"postback\",\n              title: \"Call Postback\",\n              payload: \"Payload for second bubble\",\n            }]\n          }]\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n* Send list of dues.\n*\n*/\nfunction sendDuesList(recipientId) {\n  var messageData = {\n  recipient:{\n    id:recipientId\n  }, message: {\n    attachment: {\n        type: \"template\",\n        payload: {\n            template_type: \"list\",\n            top_element_style: \"compact\",\n            elements: [\n                {\n                    title: \"Classic Black T-Shirt\",\n                    subtitle: \"100% Cotton, 200% Comfortable\"\n                },\n                {\n                    title: \"Classic Gray T-Shirt\",\n                    subtitle: \"100% Cotton, 200% Comfortable\"\n                }\n            ]\n        }\n    }\n}\n    \n  };\n\n  callSendAPI(messageData);\n}\n\n\n/*\n * Send a receipt message using the Send API.\n *\n */\nfunction sendReceiptMessage(recipientId) {\n  // Generate a random receipt ID as the API requires a unique ID\n  var receiptId = \"order\" + Math.floor(Math.random()*1000);\n\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message:{\n      attachment: {\n        type: \"template\",\n        payload: {\n          template_type: \"receipt\",\n          recipient_name: \"Peter Chang\",\n          order_number: receiptId,\n          currency: \"USD\",\n          payment_method: \"Visa 1234\",\n          timestamp: \"1428444852\",\n          elements: [{\n            title: \"Oculus Rift\",\n            subtitle: \"Includes: headset, sensor, remote\",\n            quantity: 1,\n            price: 599.00,\n            currency: \"USD\",\n            image_url: SERVER_URL + \"/assets/riftsq.png\"\n          }, {\n            title: \"Samsung Gear VR\",\n            subtitle: \"Frost White\",\n            quantity: 1,\n            price: 99.99,\n            currency: \"USD\",\n            image_url: SERVER_URL + \"/assets/gearvrsq.png\"\n          }],\n          address: {\n            street_1: \"1 Hacker Way\",\n            street_2: \"\",\n            city: \"Menlo Park\",\n            postal_code: \"94025\",\n            state: \"CA\",\n            country: \"US\"\n          },\n          summary: {\n            subtotal: 698.99,\n            shipping_cost: 20.00,\n            total_tax: 57.67,\n            total_cost: 626.66\n          },\n          adjustments: [{\n            name: \"New Customer Discount\",\n            amount: -50\n          }, {\n            name: \"$100 Off Coupon\",\n            amount: -100\n          }]\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a message with Quick Reply buttons.\n *\n */\nfunction sendQuickReply(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      text: \"What's your favorite movie genre?\",\n      quick_replies: [\n        {\n          \"content_type\":\"text\",\n          \"title\":\"Action\",\n          \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_ACTION\"\n        },\n        {\n          \"content_type\":\"text\",\n          \"title\":\"Comedy\",\n          \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_COMEDY\"\n        },\n        {\n          \"content_type\":\"text\",\n          \"title\":\"Drama\",\n          \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_DRAMA\"\n        }\n      ]\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a read receipt to indicate the message has been read\n *\n */\nfunction sendReadReceipt(recipientId) {\n  console.log(\"Sending a read receipt to mark message as seen\");\n\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    sender_action: \"mark_seen\"\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send INFO of receipt type.\n *\n */\nfunction sendInfoMenu(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message:{\n    attachment:{\n      type:\"template\",\n      payload:{\n        template_type:\"button\",\n        text:\"What info to access?\\\n        Personal or Class\",\n        buttons:[\n          {\n            type:\"postback\",\n            title:\"My Personal Info\",\n            payload:\"MY_PERSONAL_INFO\"\n          },\n          {\n            type:\"postback\",\n            title:\"Class Info\",\n            payload:\"CLASS_INFO\"\n          }\n        ]\n      }\n    }\n  }\n  };\n\n  callSendAPI(messageData);\n}\n\nfunction sendClassInfoMenu(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"template\",\n        payload:{\n        template_type:\"button\",\n        text:\"Choose a class\",\n        buttons:[\n          {\n            type:\"postback\",\n            title:\"MATH 110\",\n            payload:\"MATH_110\"\n          },\n          {\n            type:\"postback\",\n            title:\"CompSci 188\",\n            payload:\"COMPSCI_188\"\n          }\n        ]\n      }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n// {\n//           template_type: \"generic\",\n//           elements: [{\n//             title: \"MATH 110\",\n//             subtitle: \"Linear Algebra II\",\n//             item_url: \"https://math.berkeley.edu/~frenkel/math110/\",\n//             image_url: SERVER_URL + \"/assets/like.png\",\n//           }]\n//         }\n\n// {\n//           template_type: \"generic\",\n//           elements: [{\n//             title: \"CompSci 188\",\n//             subtitle: \"Introduction to AI\",\n//             item_url: \"http://ai.berkeley.edu/home.html\",\n//             image_url: SERVER_URL + \"/assets/Controls.JPG\",\n//           }]\n//         }\n\nfunction sendMyPersonalInfoMenu(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"template\",\n        payload: {\n          template_type: \"generic\",\n          elements: [{\n            title: \"Teddy Zhang\",\n            subtitle: \"UC Berkeley Sophomore\",\n            item_url: \"http://caldining.berkeley.edu/menus/all-locations-d1\",\n            image_url: SERVER_URL + \"/assets/Picture2.png\",\n          }]\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n// var mysql = require(\"mysql\");\n//var con = mysql.createConnection({\n  //host: 'calbot2016.cz0u2urohrfo.us-west-2.rds.amazonaws.com'\",\n  //user: 'fongtinyik',\n  //password: 'calbot2016',\n  //database: 'CalBot'\n//});\n//connection.connect(function(err) {\n          //if (err) console.log('Error connecting to Db');\n               //return;\n           //console.log('Connection established');\n  //});\n//con.end(function(err) {\n        //connection.query('SELECT * FROM users', function(err, rows, fields) {\n            //if (err) {\n                //console.log(\"Error connecting to db\");\n                //console.log(err.code);\n            //} else {\n                // Do something\n            //}\n        //});\n        //connection.end(function(err) {});\n/*\n * Send Manage Menu\n *\n */\nfunction sendManageMenu(recipientId) {\n  console.log(\"Sending Manage Menu\");\n\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message:{\n    attachment:{\n      type:\"template\",\n      payload:{\n        template_type:\"button\",\n        text:\"Things to change\",\n        buttons:[\n          {\n            type:\"postback\",\n            title:\"Add Assignment\",\n            payload:\"ADD_ASS\"\n          },\n          {\n            type:\"postback\",\n            title:\"Enroll Class\",\n            payload:\"ENROLL_CLASS\"\n          },\n          {\n            type:\"postback\",\n            title:\"Drop Class\",\n            payload:\"DROP_CLASS\"\n          }\n        ]\n      }\n    }\n  }\n  };\n\n  callSendAPI(messageData);\n}\n\n\n/*\n * Turn typing indicator on\n *\n */\nfunction sendTypingOn(recipientId) {\n  console.log(\"Turning typing indicator on\");\n\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    sender_action: \"typing_on\"\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Turn typing indicator off\n *\n */\nfunction sendTypingOff(recipientId) {\n  console.log(\"Turning typing indicator off\");\n\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    sender_action: \"typing_off\"\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Send a message with the account linking call-to-action\n *\n */\nfunction sendAccountLinking(recipientId) {\n  var messageData = {\n    recipient: {\n      id: recipientId\n    },\n    message: {\n      attachment: {\n        type: \"template\",\n        payload: {\n          template_type: \"button\",\n          text: \"Welcome. Link your account.\",\n          buttons:[{\n            type: \"account_link\",\n            url: SERVER_URL + \"/authorize\"\n          }]\n        }\n      }\n    }\n  };\n\n  callSendAPI(messageData);\n}\n\n/*\n * Call the Send API. The message data goes in the body. If successful, we'll\n * get the message id in a response\n *\n */\nfunction callSendAPI(messageData) {\n  request({\n    uri: 'https://graph.facebook.com/v2.6/me/messages',\n    qs: { access_token: PAGE_ACCESS_TOKEN },\n    method: 'POST',\n    json: messageData\n\n  }, function (error, response, body) {\n    if (!error && response.statusCode == 200) {\n      var recipientId = body.recipient_id;\n      var messageId = body.message_id;\n\n      if (messageId) {\n        console.log(\"Successfully sent message with id %s to recipient %s\",\n          messageId, recipientId);\n      } else {\n      console.log(\"Successfully called Send API for recipient %s\",\n        recipientId);\n      }\n    } else {\n      console.error(\"Failed calling Send API\", response.statusCode, response.statusMessage, body.error);\n    }\n  });\n}\n\n/*\n * Query SQL\n * \n *\n */\nfunction queryDB(queryMsg) {\n  //FIXME\n  connection.query(queryMsg, function(err, rows, fields) {\n    if (err) {\n        console.log(\"Error connecting to db\");\n        console.log(err.code);\n    } else {\n        console.log(rows[0].id);\n    }\n  });\n}\n\n// Start server\n// Webhooks must be available via SSL with a certificate signed by a valid\n// certificate authority.\napp.listen(app.get('port'), function() {\n  console.log('Node app is running on port', app.get('port'));\n});\n\n\n\nmodule.exports = app;\n","undoManager":{"mark":33,"position":100,"stack":[[{"start":{"row":955,"column":10},"end":{"row":955,"column":11},"action":"remove","lines":[" "],"id":5260}],[{"start":{"row":955,"column":10},"end":{"row":955,"column":11},"action":"insert","lines":[":"],"id":5261}],[{"start":{"row":955,"column":11},"end":{"row":955,"column":12},"action":"insert","lines":[" "],"id":5262}],[{"start":{"row":955,"column":12},"end":{"row":955,"column":20},"action":"insert","lines":["'CalBot'"],"id":5263}],[{"start":{"row":955,"column":20},"end":{"row":955,"column":21},"action":"insert","lines":[","],"id":5264}],[{"start":{"row":955,"column":20},"end":{"row":955,"column":21},"action":"remove","lines":[","],"id":5265}],[{"start":{"row":406,"column":23},"end":{"row":407,"column":8},"action":"insert","lines":["","      co"],"id":5266,"ignore":true}],[{"start":{"row":407,"column":8},"end":{"row":407,"column":10},"action":"insert","lines":["ns"],"id":5267,"ignore":true}],[{"start":{"row":407,"column":6},"end":{"row":407,"column":10},"action":"remove","lines":["cons"],"id":5268,"ignore":true},{"start":{"row":407,"column":6},"end":{"row":407,"column":15},"action":"insert","lines":["console.l"]}],[{"start":{"row":407,"column":15},"end":{"row":407,"column":16},"action":"insert","lines":["o"],"id":5269,"ignore":true}],[{"start":{"row":407,"column":14},"end":{"row":407,"column":16},"action":"remove","lines":["lo"],"id":5270,"ignore":true},{"start":{"row":407,"column":14},"end":{"row":407,"column":19},"action":"insert","lines":["log()"]}],[{"start":{"row":407,"column":18},"end":{"row":407,"column":20},"action":"insert","lines":["''"],"id":5271,"ignore":true}],[{"start":{"row":407,"column":19},"end":{"row":407,"column":21},"action":"insert","lines":["=="],"id":5272,"ignore":true}],[{"start":{"row":407,"column":21},"end":{"row":407,"column":27},"action":"insert","lines":["======"],"id":5273,"ignore":true}],[{"start":{"row":407,"column":27},"end":{"row":407,"column":28},"action":"insert","lines":["="],"id":5274,"ignore":true}],[{"start":{"row":953,"column":2},"end":{"row":953,"column":3},"action":"insert","lines":["/"],"id":5275}],[{"start":{"row":953,"column":3},"end":{"row":953,"column":4},"action":"insert","lines":["/"],"id":5276}],[{"start":{"row":407,"column":30},"end":{"row":407,"column":31},"action":"insert","lines":[";"],"id":5277,"ignore":true}],[{"start":{"row":954,"column":2},"end":{"row":954,"column":3},"action":"insert","lines":["/"],"id":5278},{"start":{"row":954,"column":3},"end":{"row":954,"column":4},"action":"insert","lines":["/"]}],[{"start":{"row":408,"column":28},"end":{"row":409,"column":32},"action":"insert","lines":["","       console.log('=========');"],"id":5279,"ignore":true}],[{"start":{"row":956,"column":2},"end":{"row":956,"column":3},"action":"insert","lines":["/"],"id":5280},{"start":{"row":956,"column":3},"end":{"row":956,"column":4},"action":"insert","lines":["/"]}],[{"start":{"row":409,"column":6},"end":{"row":409,"column":7},"action":"remove","lines":[" "],"id":5281,"ignore":true}],[{"start":{"row":957,"column":2},"end":{"row":957,"column":10},"action":"remove","lines":["database"],"id":5282},{"start":{"row":957,"column":2},"end":{"row":957,"column":3},"action":"insert","lines":["/"]}],[{"start":{"row":957,"column":3},"end":{"row":957,"column":4},"action":"insert","lines":["/"],"id":5283}],[{"start":{"row":958,"column":0},"end":{"row":958,"column":1},"action":"insert","lines":["/"],"id":5284}],[{"start":{"row":958,"column":1},"end":{"row":958,"column":2},"action":"insert","lines":["/"],"id":5285}],[{"start":{"row":942,"column":12},"end":{"row":942,"column":115},"action":"remove","lines":["var query = connection.query('INSERT INTO users (id, notif) VALUES (senderID, 1)', {name: messageText},"],"id":5286}],[{"start":{"row":942,"column":10},"end":{"row":942,"column":12},"action":"remove","lines":["  "],"id":5287}],[{"start":{"row":942,"column":8},"end":{"row":942,"column":10},"action":"remove","lines":["  "],"id":5288}],[{"start":{"row":942,"column":6},"end":{"row":942,"column":8},"action":"remove","lines":["  "],"id":5289}],[{"start":{"row":942,"column":4},"end":{"row":942,"column":6},"action":"remove","lines":["  "],"id":5290}],[{"start":{"row":942,"column":2},"end":{"row":942,"column":4},"action":"remove","lines":["  "],"id":5291}],[{"start":{"row":942,"column":0},"end":{"row":942,"column":2},"action":"remove","lines":["  "],"id":5292}],[{"start":{"row":941,"column":59},"end":{"row":942,"column":0},"action":"remove","lines":["",""],"id":5293}],[{"start":{"row":941,"column":59},"end":{"row":942,"column":10},"action":"remove","lines":["","          "],"id":5294}],[{"start":{"row":955,"column":4},"end":{"row":955,"column":5},"action":"insert","lines":["d"],"id":5295}],[{"start":{"row":955,"column":5},"end":{"row":955,"column":6},"action":"insert","lines":["a"],"id":5296}],[{"start":{"row":955,"column":6},"end":{"row":955,"column":7},"action":"insert","lines":["t"],"id":5297}],[{"start":{"row":955,"column":7},"end":{"row":955,"column":8},"action":"insert","lines":["a"],"id":5298}],[{"start":{"row":955,"column":8},"end":{"row":955,"column":9},"action":"insert","lines":["b"],"id":5299}],[{"start":{"row":955,"column":9},"end":{"row":955,"column":10},"action":"insert","lines":["a"],"id":5300}],[{"start":{"row":955,"column":10},"end":{"row":955,"column":11},"action":"insert","lines":["s"],"id":5301}],[{"start":{"row":955,"column":11},"end":{"row":955,"column":12},"action":"insert","lines":["e"],"id":5302}],[{"start":{"row":957,"column":0},"end":{"row":968,"column":25},"action":"insert","lines":["connection.connect(function(err) {","          if (err) console.log(err.code);","        });","        connection.query('SELECT * FROM users', function(err, rows, fields) {","            if (err) {","                console.log(\"Error connecting to db\");","                console.log(err.code);","            } else {","                // Do something","            }","        });","        connection.end();"],"id":5303}],[{"start":{"row":957,"column":0},"end":{"row":957,"column":1},"action":"insert","lines":["/"],"id":5304}],[{"start":{"row":957,"column":1},"end":{"row":957,"column":2},"action":"insert","lines":["/"],"id":5305}],[{"start":{"row":958,"column":10},"end":{"row":958,"column":11},"action":"insert","lines":["/"],"id":5306}],[{"start":{"row":958,"column":11},"end":{"row":958,"column":12},"action":"insert","lines":["/"],"id":5307}],[{"start":{"row":959,"column":8},"end":{"row":959,"column":9},"action":"insert","lines":["/"],"id":5308}],[{"start":{"row":959,"column":9},"end":{"row":959,"column":10},"action":"insert","lines":["/"],"id":5309}],[{"start":{"row":960,"column":8},"end":{"row":960,"column":9},"action":"insert","lines":["/"],"id":5310}],[{"start":{"row":960,"column":9},"end":{"row":960,"column":10},"action":"insert","lines":["/"],"id":5311}],[{"start":{"row":961,"column":12},"end":{"row":961,"column":13},"action":"insert","lines":["/"],"id":5312}],[{"start":{"row":961,"column":13},"end":{"row":961,"column":14},"action":"insert","lines":["/"],"id":5313}],[{"start":{"row":962,"column":16},"end":{"row":962,"column":17},"action":"insert","lines":["/"],"id":5314}],[{"start":{"row":962,"column":17},"end":{"row":962,"column":18},"action":"insert","lines":["/"],"id":5315}],[{"start":{"row":963,"column":16},"end":{"row":963,"column":17},"action":"insert","lines":["/"],"id":5316}],[{"start":{"row":963,"column":17},"end":{"row":963,"column":18},"action":"insert","lines":["/"],"id":5317}],[{"start":{"row":964,"column":12},"end":{"row":964,"column":13},"action":"insert","lines":["/"],"id":5318}],[{"start":{"row":964,"column":13},"end":{"row":964,"column":14},"action":"insert","lines":["/"],"id":5319}],[{"start":{"row":966,"column":12},"end":{"row":966,"column":13},"action":"insert","lines":["/"],"id":5320}],[{"start":{"row":966,"column":13},"end":{"row":966,"column":14},"action":"insert","lines":["/"],"id":5321}],[{"start":{"row":967,"column":8},"end":{"row":967,"column":9},"action":"insert","lines":["/"],"id":5322}],[{"start":{"row":967,"column":9},"end":{"row":967,"column":10},"action":"insert","lines":["/"],"id":5323}],[{"start":{"row":968,"column":8},"end":{"row":968,"column":9},"action":"insert","lines":["/"],"id":5324}],[{"start":{"row":968,"column":9},"end":{"row":968,"column":10},"action":"insert","lines":["/"],"id":5325}],[{"start":{"row":958,"column":33},"end":{"row":958,"column":41},"action":"remove","lines":["err.code"],"id":5326},{"start":{"row":958,"column":33},"end":{"row":958,"column":57},"action":"insert","lines":["'Error connecting to Db'"]}],[{"start":{"row":958,"column":59},"end":{"row":959,"column":0},"action":"insert","lines":["",""],"id":5327},{"start":{"row":959,"column":0},"end":{"row":959,"column":10},"action":"insert","lines":["          "]}],[{"start":{"row":959,"column":10},"end":{"row":959,"column":11},"action":"insert","lines":[" "],"id":5328}],[{"start":{"row":959,"column":11},"end":{"row":959,"column":12},"action":"insert","lines":[" "],"id":5329}],[{"start":{"row":959,"column":12},"end":{"row":959,"column":13},"action":"insert","lines":[" "],"id":5330}],[{"start":{"row":959,"column":13},"end":{"row":959,"column":14},"action":"insert","lines":[" "],"id":5331}],[{"start":{"row":959,"column":14},"end":{"row":959,"column":15},"action":"insert","lines":[" "],"id":5332}],[{"start":{"row":959,"column":15},"end":{"row":959,"column":16},"action":"insert","lines":["/"],"id":5333}],[{"start":{"row":959,"column":16},"end":{"row":959,"column":17},"action":"insert","lines":["/"],"id":5334}],[{"start":{"row":959,"column":17},"end":{"row":959,"column":18},"action":"insert","lines":["r"],"id":5335}],[{"start":{"row":959,"column":18},"end":{"row":959,"column":19},"action":"insert","lines":["e"],"id":5336}],[{"start":{"row":959,"column":19},"end":{"row":959,"column":20},"action":"insert","lines":["t"],"id":5337}],[{"start":{"row":959,"column":20},"end":{"row":959,"column":21},"action":"insert","lines":["u"],"id":5338}],[{"start":{"row":959,"column":21},"end":{"row":959,"column":22},"action":"insert","lines":["r"],"id":5339}],[{"start":{"row":959,"column":22},"end":{"row":959,"column":23},"action":"insert","lines":["n"],"id":5340}],[{"start":{"row":959,"column":23},"end":{"row":959,"column":24},"action":"insert","lines":[";"],"id":5341}],[{"start":{"row":959,"column":24},"end":{"row":960,"column":0},"action":"insert","lines":["",""],"id":5342},{"start":{"row":960,"column":0},"end":{"row":960,"column":15},"action":"insert","lines":["               "]}],[{"start":{"row":960,"column":14},"end":{"row":960,"column":15},"action":"remove","lines":[" "],"id":5343}],[{"start":{"row":960,"column":12},"end":{"row":960,"column":14},"action":"remove","lines":["  "],"id":5344}],[{"start":{"row":960,"column":12},"end":{"row":960,"column":50},"action":"insert","lines":["console.log('Connection established');"],"id":5345}],[{"start":{"row":960,"column":12},"end":{"row":960,"column":13},"action":"insert","lines":["/"],"id":5346}],[{"start":{"row":960,"column":13},"end":{"row":960,"column":14},"action":"insert","lines":["/"],"id":5347}],[{"start":{"row":960,"column":10},"end":{"row":960,"column":12},"action":"remove","lines":["  "],"id":5348}],[{"start":{"row":960,"column":10},"end":{"row":960,"column":11},"action":"insert","lines":[" "],"id":5349}],[{"start":{"row":961,"column":2},"end":{"row":961,"column":8},"action":"remove","lines":["      "],"id":5350}],[{"start":{"row":961,"column":7},"end":{"row":962,"column":0},"action":"insert","lines":["",""],"id":5351},{"start":{"row":962,"column":0},"end":{"row":962,"column":2},"action":"insert","lines":["  "]}],[{"start":{"row":962,"column":2},"end":{"row":962,"column":25},"action":"insert","lines":["con.end(function(err) {"],"id":5352}],[{"start":{"row":962,"column":2},"end":{"row":962,"column":3},"action":"insert","lines":["/"],"id":5353}],[{"start":{"row":962,"column":3},"end":{"row":962,"column":4},"action":"insert","lines":["/"],"id":5354}],[{"start":{"row":962,"column":0},"end":{"row":962,"column":2},"action":"remove","lines":["  "],"id":5355}],[{"start":{"row":971,"column":26},"end":{"row":971,"column":41},"action":"insert","lines":["function(err) {"],"id":5356}],[{"start":{"row":971,"column":25},"end":{"row":971,"column":26},"action":"remove","lines":[")"],"id":5357}],[{"start":{"row":971,"column":40},"end":{"row":971,"column":41},"action":"insert","lines":["}"],"id":5358}],[{"start":{"row":971,"column":41},"end":{"row":971,"column":42},"action":"insert","lines":[")"],"id":5359}],[{"start":{"row":216,"column":28},"end":{"row":217,"column":30},"action":"remove","lines":["ho;","  var messageId = message.mid;"],"id":5360,"ignore":true},{"start":{"row":216,"column":28},"end":{"row":217,"column":30},"action":"insert","lines":["ho;","  var messageId = message.mid;"]}]]},"ace":{"folds":[{"start":{"row":478,"column":40},"end":{"row":494,"column":0},"placeholder":"..."}],"scrolltop":13161,"scrollleft":0,"selection":{"start":{"row":971,"column":43},"end":{"row":971,"column":43},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":955,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1478998151907}